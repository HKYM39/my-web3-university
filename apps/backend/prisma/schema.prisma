generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  USER
  CREATOR
  ADMIN
}

enum CourseStatus {
  DRAFT
  PENDING
  PUBLISHED
  REJECTED
}

enum PayToken {
  YIDENG
  ETH
}

enum RewardType {
  COURSE
  DAILY
}

enum ArticleStatus {
  DRAFT
  PUBLISHED
}

model User {
  id            BigInt          @id @default(autoincrement()) @db.BigInt
  walletAddress String          @unique @db.VarChar(64)
  nickname      String?         @db.VarChar(64)
  role          UserRole        @default(USER)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  nonce         UserNonce?
  purchases     UserCourse[]
  progresses    LearningProgress[]
  rewards       RewardRecord[]
  incomes       IncomeRecord[]  @relation("IncomeAuthor")
  aavePositions AavePosition[]
}

model UserNonce {
  id            BigInt   @id @default(autoincrement()) @db.BigInt
  walletAddress String   @unique @db.VarChar(64)
  nonce         String   @db.VarChar(128)
  expiredAt     DateTime
  createdAt     DateTime @default(now())
  user          User?    @relation(fields: [walletAddress], references: [walletAddress])
}

model Course {
  id            BigInt            @id @default(autoincrement()) @db.BigInt
  courseUid     String            @unique @db.VarChar(64)
  title         String            @db.VarChar(255)
  description   String?           @db.Text
  authorWallet  String            @db.VarChar(64)
  price         Decimal           @db.Decimal(36, 18)
  payToken      PayToken
  status        CourseStatus      @default(DRAFT)
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  contents      CourseContent[]
  purchases     UserCourse[]
  progresses    LearningProgress[]
  rewardRecords RewardRecord[]
  incomeRecords IncomeRecord[]
}

model CourseContent {
  id         BigInt   @id @default(autoincrement()) @db.BigInt
  courseId   BigInt   @db.BigInt
  title      String?  @db.VarChar(255)
  videoUrl   String?  @db.Text
  sortOrder  Int      @default(0)
  createdAt  DateTime @default(now())
  course     Course   @relation(fields: [courseId], references: [id])
}

model UserCourse {
  id            BigInt   @id @default(autoincrement()) @db.BigInt
  walletAddress String   @db.VarChar(64)
  courseUid     String   @db.VarChar(64)
  nftTokenId    String   @db.VarChar(128)
  txHash        String?  @db.VarChar(128)
  createdAt     DateTime @default(now())
  user          User?    @relation(fields: [walletAddress], references: [walletAddress])
  course        Course   @relation(fields: [courseUid], references: [courseUid])

  @@unique([walletAddress, courseUid])
  @@index([walletAddress])
  @@index([courseUid])
}

model LearningProgress {
  id            BigInt    @id @default(autoincrement()) @db.BigInt
  walletAddress String    @db.VarChar(64)
  courseUid     String    @db.VarChar(64)
  progress      Decimal   @db.Decimal(5, 2)
  lastWatchAt   DateTime?
  updatedAt     DateTime  @updatedAt
  user          User?     @relation(fields: [walletAddress], references: [walletAddress])
  course        Course?   @relation(fields: [courseUid], references: [courseUid])

  @@unique([walletAddress, courseUid])
}

model RewardRecord {
  id            BigInt    @id @default(autoincrement()) @db.BigInt
  walletAddress String    @db.VarChar(64)
  courseUid     String?   @db.VarChar(64)
  rewardAmount  Decimal   @db.Decimal(36, 18)
  rewardType    RewardType
  txHash        String?   @db.VarChar(128)
  createdAt     DateTime  @default(now())
  user          User?     @relation(fields: [walletAddress], references: [walletAddress])
  course        Course?   @relation(fields: [courseUid], references: [courseUid])

  @@index([walletAddress])
}

model IncomeRecord {
  id           BigInt   @id @default(autoincrement()) @db.BigInt
  courseUid    String?  @db.VarChar(64)
  authorWallet String?  @db.VarChar(64)
  amount       Decimal  @db.Decimal(36, 18)
  token        String?  @db.VarChar(32)
  txHash       String?  @db.VarChar(128)
  createdAt    DateTime @default(now())
  course       Course?  @relation(fields: [courseUid], references: [courseUid])
  author       User?    @relation("IncomeAuthor", fields: [authorWallet], references: [walletAddress])

  @@index([authorWallet])
}

model AavePosition {
  id            BigInt    @id @default(autoincrement()) @db.BigInt
  walletAddress String    @db.VarChar(64)
  asset         String?   @db.VarChar(32)
  amount        Decimal?  @db.Decimal(36, 18)
  aTokenBalance Decimal?  @db.Decimal(36, 18)
  apy           Decimal?  @db.Decimal(8, 4)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  user          User?     @relation(fields: [walletAddress], references: [walletAddress])
}

model AdminLog {
  id          BigInt   @id @default(autoincrement()) @db.BigInt
  adminWallet String?  @db.VarChar(64)
  action      String?  @db.VarChar(255)
  targetId    String?  @db.VarChar(64)
  createdAt   DateTime @default(now())
}

model Article {
  id        BigInt        @id @default(autoincrement()) @db.BigInt
  title     String        @db.VarChar(255)
  content   String        @db.Text
  status    ArticleStatus @default(DRAFT)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
}

model HomepageConfig {
  id         Int       @id @default(1)
  courseUids String[]
  updatedAt  DateTime  @updatedAt
}
